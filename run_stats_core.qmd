---
title: "Statistical Tests for the 'Doors' project"
format: html
editor: visual
---

# Preparing the data

```{r}
#| include: false
library(tidyverse)
library(ez)
library(emmeans)
library(afex)
afex_options(emmeans_model = "multivariate")

```

## Load and format the data

We'll use the generic wrangled data file, "exp_lt_avg.csv".

```{r}
project_path <- getwd()
exp <- "exp_lt" # experiment: 'exp_ts' (task-switching) or 'exp_lt' (learning transfer)
data <- read.csv(file.path(project_path, "res", paste(paste(exp, "avg", sep = "_"), ".csv", sep = "")))
```

Make sure that the key variables are formatted as factors, ready for ANOVAs.

```{r}
training_data <- data %>% 
  filter(ses==2) %>% 
  select(sub, train_type, switch, context_changes, accuracy,
         setting_errors, general_errors) %>% 
  mutate(train_type = train_type-1) %>% 
  mutate(sub = factor(sub), 
         train_type = factor(train_type), 
         train_type = case_when(train_type==0~"low",train_type==1~"high"),
         switch = factor(switch), 
         switch = case_when(switch==0~"stay",switch==1~"switch"))

test_data <- data %>% 
  filter(ses==3,switch==0) %>% 
  select(sub, train_type, transfer, full_transfer_first, accuracy, learned_setting_errors)
test_data$general_errors <- 1 - test_data$accuracy - test_data$learned_setting_errors

tmp <- data %>% filter(ses == 2 & switch == 0) %>% 
  select(sub, context, transition_probabilities) %>%
  group_by(sub) %>% 
  summarise(mu_tp = mean(transition_probabilities))
test_data <- inner_join(test_data, tmp, by="sub")

k4_data <- read_csv(file.path(project_path, "res", paste(paste(exp, "maggi-k4", sep = "_"), ".csv", sep = "")), show_col_types = FALSE)
k4_data <- k4_data %>% 
  filter(ses==3) %>% 
  select(sid, transfer, nclicks, k4_onset) %>% 
  rename(sub=sid)
test_data <- inner_join(test_data, k4_data, by=c("sub","transfer"))

test_data <- test_data %>% 
  mutate(train_type = train_type-1) %>% 
  mutate(sub = factor(sub), 
         train_type = factor(train_type), 
         train_type = case_when(train_type==0~"low",train_type==1~"high"),
         transfer = factor(transfer), 
         transfer = case_when(transfer==1~"complete",transfer==2~"partial"),
         full_transfer_first = factor(full_transfer_first),
         full_transfer_first = case_when(full_transfer_first==0~"pf",full_transfer_first==1~"cf"))
```

# Train phase

## General errors

Test whether experiencing a low or high rate of context switches during training influenced how often people clicked doors that were never relevant for either house (general errors).

### ANOVA

```{r}
training_results <- aov_ez("sub", "general_errors", training_data, within = "switch", between = c("train_type"), fun_aggregate = mean)
summary(training_results)
```

### Contrasts

```{r}
sum_emm_int <- emmeans(training_results, c("train_type", "switch")) #get est. marginal means
switch_effect <- c(-1, -1, 1, 1) #make a vector comparing switch vs stay trials
main_effect_contrasts <- (list(switch_effect))
contrast(sum_emm_int, main_effect_contrasts) #perform contrasts analyses for main effects
```

### Descriptive statistics

```{r}
training_data %>% 
  group_by(switch) %>% 
  summarise(means = mean(general_errors),
            sd = sd(general_errors)) 
```

## Context changes

Test whether experiencing a high or low rate of context switches during training (train_type) influenced how likely participants were to spontaneously explore the other context (context changes).

### ANOVA

```{r}
training_results <- aov_ez("sub","context_changes", training_data, within = "switch", between = c("train_type"), fun_aggregate = mean)
summary(training_results)
```

### Contrasts

```{r}
sum_emm_int <- emmeans(training_results, c("train_type", "switch"))
switch_effect <- c(-1, -1, 1, 1) #vector comparing complete vs partial transfer
group_effect <- c(1, -1, 1, -1) #vector comparing low switch vs high switch
interaction_effects<-switch_effect * group_effect #multiply vectors
contrast(sum_emm_int, list(interaction_effects)) #perform contrasts analyses
low_switch_effect <- c(0, -1, 0, 1) #comparing accuracies for low-switch 
high_switch_effect <- c(1, 0, -1, 0) #comparing accuracies for high-switch 
stay_trials_effect <- c(1, -1, 0, 0) # comparing between groups on stay trials
switch_trials_effect <- c(0, 0, 1, -1) # comparing  between groups on sitch trials
simple_effect_contrasts <- list(low_switch_effect, 
                                high_switch_effect,
                                stay_trials_effect,
                                switch_trials_effect)
contrast(sum_emm_int, simple_effect_contrasts) #contrasts analyses for simple effects
```

### Descriptive statistics

```{r}
training_data %>% 
  group_by(train_type, switch) %>% 
  summarise(means = mean(context_changes),
            sd = sd(context_changes)) 
```

# Test phase

## Accuracy

Are people in the low or high context switching training group more accurate on partial or complete transfer?

### ANOVA

```{r}
test_results <- aov_ez("sub", "accuracy", test_data, within = "transfer", between = c("train_type", "full_transfer_first"))
summary(test_results)
```

### Contrasts

```{r}
#   interaction
sum_emm_int <- emmeans(test_results, c("train_type", "transfer"))
transfer_effect <- c(1, 1, -1, -1) #vector comparing complete vs partial transfer
group_effect <- c(1, -1, 1, -1) #vector comparing low switch vs high switch
interaction_effects<-transfer_effect * group_effect #multiply vectors
contrast(sum_emm_int, list(interaction_effects)) #perform contrasts analyses
#   simple effects
low_switch_transfer_effect <- c(0, 1, 0, -1) #comparing accuracies for low-switch only
high_switch_transfer_effect <- c(1, 0, -1, 0) #comparing accuracies for high-switch only
complete_transfer_effect <- c(1, -1, 0, 0) # comparing between groups on stay trials
partial_transfer_effect <- c(0, 0, 1, -1) # comparing  between groups on sitch trials
simple_effect_contrasts <- list(low_switch_transfer_effect, 
                                high_switch_transfer_effect,
                                complete_transfer_effect,
                                partial_transfer_effect
)
contrast(sum_emm_int, simple_effect_contrasts) #contrasts analyses for simple effects

```

### Descriptive statistics

```{r}
#   variance
test_data %>% 
  group_by(train_type, transfer, full_transfer_first) %>% 
  summarise(variance = var(accuracy)) 
#   mean and sd
test_data %>% 
  group_by(train_type, transfer) %>% 
  summarise(mean_acc = mean(accuracy),
            sd = sd(accuracy))
```

## Learned setting errors

Do people revert to clicking on doors that belonged to a house during training, even though they don't belong to the current house?

### ANOVA

```{r}
test_results <- aov_ez("sub", "accuracy", test_data, within = "transfer", between = c("train_type", "full_transfer_first"))
summary(test_results)
```

We don't run contrasts here, because the omnibus test does reach significance.

### Descriptive statistics

```{r}
test_data %>% 
  group_by(transfer) %>% 
  summarise(mean = mean(learned_setting_errors),
            sd = sd(learned_setting_errors))
```

## General errors

Do people who have experienced low or high rates of context switching during training select more doors that have never belonged to a house (general_errors) during partial or complete transfer?

### ANOVA

```{r}
test_results <- aov_ez("sub", "general_errors", test_data, within = "transfer", between = c("train_type", "full_transfer_first"))
summary(test_results)

test_results <- ezANOVA(data=test_data, dv=general_errors, wid=sub, within=transfer, between=.(train_type, full_transfer_first))
test_results
```

## Transition probabilities

Some people were very consistent in how they stepped between the target doors in each house during training. If they consistently stepped between two doors that were then included in their partial transfer context, they might perform better in the partial transfer context than someone who stepped between those two doors less often. Does transition probability during the train phase within the two pairs of doors that later form the partial transfer context correlate with partial transfer accuracy?

### Correlation

```{r}
#   correlation test for low switch group
cor_test_data_low <- test_data %>% filter(transfer == "partial", train_type == "low") 
with(cor_test_data_low, cor.test(x=mu_tp, y=accuracy))
#   correlation test for high switch group
cor_test_data_high <- test_data %>% filter(transfer == "partial", train_type == "high")
with(cor_test_data_high, cor.test(x=mu_tp, y=accuracy))
```

## "Know 4"

We have modelled participants' clicks to estimate when during the test phase there is consistent evidence that they know all four doors (k4_onset), separately for the partial and complete transfer contexts. Do people who have experienced low or high rates of context switching during training know all four doors sooner?

First, exclude the people who never demonstrated that they knew all four doors, and print the new n.

```{r}
test_data <- test_data %>% filter(k4_onset != Inf)
length(unique(test_data$sub))
```

### ANOVA

```{r}
test_results <- aov_ez("sub", "k4_onset", test_data, within = "transfer", between = c("train_type", "full_transfer_first"))
summary(test_results)
```

### Contrasts

```{r}
#   interaction effect
sum_emm_int <- emmeans(test_results, c("train_type", "transfer"))
transfer_effect <- c(1, 1, -1, -1) #vector comparing complete vs partial transfer
group_effect <- c(1, -1, 1, -1) #vector comparing low switch vs high switch
interaction_effects<-transfer_effect * group_effect #multiply vectors
contrast(sum_emm_int, list(interaction_effects)) #perform contrasts analyses
#   simple effects
low_switch_transfer_effect <- c(0, 1, 0, -1) #comparing accuracie for low-switch only
high_switch_transfer_effect <- c(1, 0, -1, 0) #comparing accuracies for high-switch only
complete_transfer_effect <- c(1, -1, 0, 0) # comparing between groups on stay trials
partial_transfer_effect <- c(0, 0, 1, -1) # comparing  between groups on sitch trials
eimple_effect_contrasts <- list(low_switch_transfer_effect, #simple effects
                                high_switch_transfer_effect,
                                complete_transfer_effect,
                                partial_transfer_effect
)
contrast(sum_emm_int, simple_effect_contrasts) #contrasts analyses for simple effects
```

### Descriptive statistics

```{r}
#   mean and sd
test_means <- test_data %>% 
  group_by(train_type, transfer) %>% 
  summarise(mean_k4 = mean(k4_onset),
            sd = sd(k4_onset))
```
